<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
  <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/@mdi/font@4.x/css/materialdesignicons.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.min.css" rel="stylesheet">
  <link href="https://cdn.bootcss.com/bootstrap/3.3.5/css/bootstrap.css" rel="stylesheet">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">
</head>

<body>
  <div id="app">
    <v-app id="inspire">
      <v-app-bar app>
        <v-toolbar-title>My Memory Videos</v-toolbar-title>
      </v-app-bar>

      <v-main class="grey lighten-2">
        <v-alert type="success" th:if="${successMessage != null}">
          <span th:text="${successMessage}">successMessage</span>
        </v-alert>
        <v-alert type="warning" th:if="${alertMessage != null}">
          <span th:text="${alertMessage}">alertMessage</span>
        </v-alert>
        <v-container>
          <v-card elevation="2">
            <v-card-title>ここから動画をアップロードします</v-card-title>
            <form method="post" enctype="multipart/form-data">
              <input type="file" name="upload_file" id="upload_file" accept=".mp4,.webm" style="margin-left: 5px;"
                v-on:change="getFileDate"></input>
              <input type="hidden" name="file_date" id="file_date"></input>
              <v-btn type="submit" formaction="/upload" style="margin-left: 5px;">アップロード</v-btn>
            </form>
            <v-divider></v-divider>
            <v-card-title>ファイル削除</v-card-title>
            <form method="post" enctype="multipart/form-data">
              <input type="text" name="delete_file" style="margin-left: 5px;"></input>
              <v-btn type="submit" formaction="/delete" style="margin-left: 5px;">ファイルの削除</v-btn>
            </form>
          </v-card>
        </v-container>
        <template v-for="fileData in getItems">
          <v-container>
            <v-card elevation="2">
              <v-card-title>{{fileData.fileName}}</v-card-title>
              <video :src="'/fetch/'+fileData.fileName" controls style="width: 100%;"></video>
            </v-card>
          </v-container>
        </template>
        <paginate :page-count="getPageCount" :page-range="3" :margin-pages="2" :click-handler="clickCallback"
          :prev-text="'＜'" :next-text="'＞'" :container-class="'pagination'" :page-class="'page-item'">
        </paginate>
      </v-main>
    </v-app>


  </div>

  <script src="https://cdn.jsdelivr.net/npm/vue@2.x/dist/vue.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://unpkg.com/vuejs-paginate@2.1.0"></script>
  <script>
    Vue.component('paginate', VuejsPaginate);
    new Vue({
      el: '#app',
      vuetify: new Vuetify(),
      data: {
        fileDataList: [],
        parPage: 5,
        currentPage: 1
      },
      methods: {
        getfileDataList: function () {
          const path = '/fileData';
          axios.get(path)
            .then(response => {
              this.fileDataList = response.data
            })
            .catch(error => {
              console.log(error)
            });
        },
        clickCallback: function (pageNum) {
          this.currentPage = Number(pageNum);
        },
        getFileDate: function (e) {
          const files = e.target.files;

          for (let file of files) {
            const date = new Date(file.lastModified);
            let element = document.getElementById('file_date');
            element.value = date;
          }
        }
      },
      computed: {
        getItems: function () {
          let current = this.currentPage * this.parPage;
          let start = current - this.parPage;
          return this.fileDataList.slice(start, current);
        },
        getPageCount: function () {
          return Math.ceil(this.fileDataList.length / this.parPage);
        }
      },
      created() {
        this.getfileDataList();
      }
    });
  </script>
</body>

</html>